version: '3.9'

services:
  db-cicd:
    container_name: njoy-db-cicd
    # https://hub.docker.com/_/postgres
    image: postgres:11.13
    restart: always
    volumes:
      - $BITBUCKET_CLONE_DIR/sql/init_db_cicd_2022_11_24_09_10_45.sql:/docker-entrypoint-initdb.d/init_db_cicd_2022_11_24_09_10_45.sql
    environment:
      POSTGRES_PASSWORD: 'postgres'
      POSTGRES_USER: 'postgres'
      POSTGRES_DB: 'dev'
    ports:
      - '5432:5432'

  api-cicd:
    container_name: api-cicd
    restart: always
    build:
      context: .
      target: build-deps
    environment:
      # This is the dotenv file generated by the bitbucket-pipeline that has the repository secret of the environment variables
      env: .env.cicd
      DOCKER: 'true'
    ports:
      - '3001:3000' # api port
    volumes:
      - $BITBUCKET_CLONE_DIR:/usr/src/backend
    depends_on:
      - db-cicd

  db:
    container_name: db
    # https://hub.docker.com/_/postgres
    image: postgres:11.13
    restart: always
    volumes:
      - ./sql/init_db_cicd_2022_11_24_09_10_45.sql:/docker-entrypoint-initdb.d/init_db_cicd_2022_11_24_09_10_45.sql
      - 'db:/var/lib/postgresql/data'
    environment:
      POSTGRES_PASSWORD: 'postgres'
      POSTGRES_USER: 'postgres'
      POSTGRES_DB: 'dev'
    ports:
      - '35432:5432'

  api-dev:
    container_name: api-dev
    build:
      context: .
      target: build-deps

    command: >
      sh -c "yarn run build && yarn run start:dev"
    environment:
      env: .env
      DOCKER: 'true'
      DB_HOST: 'db'

    ports:
      - '3001:3000' # api port
      - '9229:9229' # node debug port
    volumes:
      - './:/usr/src/backend'
    depends_on:
      - db

volumes:
  db: